I"%í<h1 class="no_toc" id="optimizing-flux-performance">Optimizing Flux Performance</h1>

<h2 class="no_toc text-delta" id="table-of-contents">Table of contents</h2>

<ol id="markdown-toc">
  <li><a href="#optimizing-flux-performance-1" id="markdown-toc-optimizing-flux-performance-1">Optimizing Flux Performance</a>    <ol>
      <li><a href="#general-recommendations-for-flux-performance-optimization" id="markdown-toc-general-recommendations-for-flux-performance-optimization">General recommendations for Flux performance optimization</a></li>
      <li><a href="#taking-advantage-of-pushdown-patterns" id="markdown-toc-taking-advantage-of-pushdown-patterns">Taking advantage of pushdown patterns</a></li>
      <li><a href="#using-schema-mutations-properly" id="markdown-toc-using-schema-mutations-properly">Using schema mutations properly</a></li>
      <li><a href="#using-variables-to-avoid-querying-data-multiple-times" id="markdown-toc-using-variables-to-avoid-querying-data-multiple-times">Using variables to avoid querying data multiple times</a></li>
      <li><a href="#dividing-processing-work-across-multiple-tasks" id="markdown-toc-dividing-processing-work-across-multiple-tasks">Dividing processing work across multiple tasks</a></li>
      <li><a href="#the-flux-profiler-package" id="markdown-toc-the-flux-profiler-package">The Flux Profiler package</a></li>
      <li><a href="#using-the-flux-extension-for-visual-studio-code-to-streamline-flux-optimization-discovery" id="markdown-toc-using-the-flux-extension-for-visual-studio-code-to-streamline-flux-optimization-discovery">Using the Flux extension for Visual Studio Code to streamline Flux optimization discovery</a></li>
      <li><a href="#other-tips" id="markdown-toc-other-tips">Other tips</a></li>
      <li><a href="#best-practices-for-receiving-help" id="markdown-toc-best-practices-for-receiving-help">Best practices for receiving help</a></li>
    </ol>
  </li>
</ol>

<hr />
<h1 id="optimizing-flux-performance-1">Optimizing Flux Performance</h1>

<p>So you‚Äôre using InfluxDB Cloud and you‚Äôre taking full advantage of Flux to create custom data processing tasks, checks, and notifications. However, you notice that some of your Flux scripts aren‚Äôt executing as quickly as you expect. In this section, we‚Äôll learn about best practices and tools for optimizing Flux performance.</p>

<h2 id="general-recommendations-for-flux-performance-optimization">General recommendations for Flux performance optimization</h2>

<p>Before diving into some of the tools you can use to optimize Flux performance, let‚Äôs dive into some general recommendations for Flux performance optimization:</p>

<ol>
  <li>Take advantage of pushdown patterns.</li>
  <li>Schema mutation functions should be applied at the end of your query.</li>
  <li>Use variables to avoid querying data multiple times.</li>
  <li>Divide processing work across multiple tasks when needed.</li>
</ol>

<p>We‚Äôll discuss each of these recommendations in detail in the following sections.</p>

<h2 id="taking-advantage-of-pushdown-patterns">Taking advantage of pushdown patterns</h2>

<p>In order to provide context for the optimization guidelines, let‚Äôs first take a moment to understand how Flux works. Flux is able to query data efficiently because some functions push down the data transformation workload to storage rather than performing the transformations in memory. Combinations of functions that do this work are called pushdown patterns. It‚Äôs best to try and use pushdown patterns whenever you can optimize your Flux query. To learn more about pushdown patterns and how Flux works, please read ‚ÄúSolution 2: Learning about memory optimizations and new pushdown patterns to optimize your Flux scripts‚Äù from <a href="https://www.influxdata.com/blog/top-5-hurdles-for-intermediate-flux-users-and-resources-for-optimizing-flux/">Top 5 Hurdles for Intermediate Flux Users and Resources for Optimizing Flux</a>.</p>

<h2 id="using-schema-mutations-properly">Using schema mutations properly</h2>

<p>Schema mutation functions are any functions that change the columns in your Flux tables. They include functions like <a href="https://docs.influxdata.com/influxdb/cloud/reference/flux/stdlib/built-in/transformations/keep/">keep()</a>, <a href="https://docs.influxdata.com/influxdb/cloud/reference/flux/stdlib/built-in/transformations/drop/">drop()</a>, <a href="https://docs.influxdata.com/influxdb/cloud/reference/flux/stdlib/built-in/transformations/rename/">rename()</a>, <a href="https://docs.influxdata.com/influxdb/cloud/reference/flux/stdlib/built-in/transformations/duplicate/">duplicate()</a>, and <a href="https://docs.influxdata.com/influxdb/cloud/reference/flux/stdlib/built-in/transformations/set/">set()</a>. If you‚Äôre using an <a href="https://docs.influxdata.com/influxdb/cloud/reference/flux/stdlib/built-in/transformations/aggregates/">aggregates</a> or <a href="https://docs.influxdata.com/influxdb/cloud/reference/flux/stdlib/built-in/transformations/selectors/">selector</a> function in your query, try to include the schema mutation functions after applying aggregation functions to preserve any pushdown patterns that you might have. Additionally, try replacing <a href="https://docs.influxdata.com/influxdb/cloud/reference/flux/stdlib/built-in/transformations/keep/">keep()</a> or <a href="https://docs.influxdata.com/influxdb/cloud/reference/flux/stdlib/built-in/transformations/drop/">drop()</a> with changes to the group key whenever possible. For example, when executing a <a href="https://docs.influxdata.com/influxdb/cloud/reference/flux/stdlib/built-in/transformations/join/">join()</a> across two fields from two buckets, join on all the like-columns instead of dropping the columns afterwards. We generate the data for this example with the <a href="https://docs.influxdata.com/influxdb/cloud/reference/flux/stdlib/array/from/">array.from()</a> function:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="dl">"</span><span class="s2">array</span><span class="dl">"</span>
<span class="k">import</span> <span class="dl">"</span><span class="s2">experimental</span><span class="dl">"</span>
<span class="nx">start</span> <span class="o">=</span> <span class="nx">experimental</span><span class="p">.</span><span class="nx">subDuration</span><span class="p">(</span>
<span class="nx">d</span><span class="p">:</span> <span class="o">-</span><span class="mi">10</span><span class="nx">m</span><span class="p">,</span>
<span class="k">from</span><span class="p">:</span> <span class="nx">now</span><span class="p">(),</span>
<span class="p">)</span>
<span class="nx">bucket1</span> <span class="o">=</span> <span class="nx">array</span><span class="p">.</span><span class="k">from</span><span class="p">(</span><span class="nx">rows</span><span class="p">:</span> <span class="p">[{</span><span class="na">_start</span><span class="p">:</span> <span class="nx">start</span><span class="p">,</span> <span class="na">_stop</span><span class="p">:</span> <span class="nx">now</span><span class="p">(),</span> <span class="na">_time</span><span class="p">:</span> <span class="nx">now</span><span class="p">(),</span><span class="na">_measurement</span><span class="p">:</span> <span class="dl">"</span><span class="s2">mymeas</span><span class="dl">"</span><span class="p">,</span> <span class="na">_field</span><span class="p">:</span> <span class="dl">"</span><span class="s2">myfield</span><span class="dl">"</span><span class="p">,</span> <span class="na">_value</span><span class="p">:</span> <span class="dl">"</span><span class="s2">foo1</span><span class="dl">"</span><span class="p">}])</span>
<span class="o">|&gt;</span> <span class="k">yield</span><span class="p">(</span><span class="nx">name</span><span class="p">:</span> <span class="dl">"</span><span class="s2">bucket1</span><span class="dl">"</span><span class="p">)</span>


<span class="nx">bucket2</span> <span class="o">=</span> <span class="nx">array</span><span class="p">.</span><span class="k">from</span><span class="p">(</span><span class="nx">rows</span><span class="p">:</span> <span class="p">[{</span><span class="na">_start</span><span class="p">:</span> <span class="nx">start</span><span class="p">,</span> <span class="na">_stop</span><span class="p">:</span> <span class="nx">now</span><span class="p">(),</span> <span class="na">_time</span><span class="p">:</span> <span class="nx">now</span><span class="p">(),</span><span class="na">_measurement</span><span class="p">:</span> <span class="dl">"</span><span class="s2">mymeas</span><span class="dl">"</span><span class="p">,</span> <span class="na">_field</span><span class="p">:</span> <span class="dl">"</span><span class="s2">myfield</span><span class="dl">"</span><span class="p">,</span> <span class="na">_value</span><span class="p">:</span> <span class="dl">"</span><span class="s2">foo2</span><span class="dl">"</span><span class="p">}])</span>
<span class="o">|&gt;</span> <span class="k">yield</span><span class="p">(</span><span class="nx">name</span><span class="p">:</span> <span class="dl">"</span><span class="s2">bucket2</span><span class="dl">"</span><span class="p">)</span>
</code></pre></div></div>

<p>The <a href="https://docs.influxdata.com/influxdb/cloud/reference/syntax/annotated-csv/">annotated CSV</a> output from our query looks like this:</p>

<p id="gdcalert12"><span style="color: red; font-weight: bold">&gt;&gt;&gt;&gt;&gt;  gd2md-html alert: inline image link here (to images/image5.png). Store image on your image server and adjust path/filename/extension if necessary. </span><br />(<a href="#">Back to top</a>)(<a href="#gdcalert13">Next alert</a>)<br /><span style="color: red; font-weight: bold">&gt;&gt;&gt;&gt;&gt; </span></p>

<p><img src="images/image5.png" alt="alt_text" title="image_tooltip" /></p>

<p><strong>Don‚Äôt</strong> use drop() unnecessarily after a join():</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">join</span><span class="p">(</span><span class="nx">tables</span><span class="p">:</span> <span class="p">{</span><span class="nl">bucket1</span><span class="p">:</span> <span class="nx">bucket1</span><span class="p">,</span> <span class="nx">bucket2</span><span class="p">:</span> <span class="nx">bucket2</span><span class="p">},</span> <span class="nx">on</span><span class="p">:</span> <span class="p">[</span><span class="dl">"</span><span class="s2">_time</span><span class="dl">"</span><span class="p">],</span> <span class="nx">method</span><span class="p">:</span> <span class="dl">"</span><span class="s2">inner</span><span class="dl">"</span><span class="p">)</span>
<span class="o">|&gt;</span> <span class="nx">drop</span><span class="p">(</span><span class="nx">columns</span><span class="p">:[</span><span class="dl">"</span><span class="s2">_start_field1</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">_stop_field1</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">_measurement_field1</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">myfield1</span><span class="dl">"</span><span class="p">])</span>
<span class="o">|&gt;</span> <span class="k">yield</span><span class="p">(</span><span class="nx">name</span><span class="p">:</span> <span class="dl">"</span><span class="s2">bad_join</span><span class="dl">"</span><span class="p">)</span>
</code></pre></div></div>

<p><strong>Do</strong> replace with changes to the group key by joining on like-columns:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">join</span><span class="p">(</span><span class="nx">tables</span><span class="p">:</span> <span class="p">{</span><span class="nl">bucket1</span><span class="p">:</span> <span class="nx">bucket1</span><span class="p">,</span> <span class="nx">bucket2</span><span class="p">:</span> <span class="nx">bucket2</span><span class="p">},</span> <span class="nx">on</span><span class="p">:</span> <span class="p">[</span><span class="dl">"</span><span class="s2">_start</span><span class="dl">"</span><span class="p">,</span><span class="dl">"</span><span class="s2">_stop</span><span class="dl">""</span><span class="s2">_time</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">_measurement</span><span class="dl">"</span><span class="p">,</span><span class="dl">"</span><span class="s2">_field</span><span class="dl">"</span><span class="p">],</span> <span class="nx">method</span><span class="p">:</span> <span class="dl">"</span><span class="s2">inner</span><span class="dl">"</span><span class="p">)</span>
<span class="o">|&gt;</span> <span class="k">yield</span><span class="p">(</span><span class="nx">name</span><span class="p">:</span> <span class="dl">"</span><span class="s2">good_join</span><span class="dl">"</span><span class="p">)</span>
</code></pre></div></div>

<p>To yield the same result:</p>

<p id="gdcalert13"><span style="color: red; font-weight: bold">&gt;&gt;&gt;&gt;&gt;  gd2md-html alert: inline image link here (to images/image6.png). Store image on your image server and adjust path/filename/extension if necessary. </span><br />(<a href="#">Back to top</a>)(<a href="#gdcalert14">Next alert</a>)<br /><span style="color: red; font-weight: bold">&gt;&gt;&gt;&gt;&gt; </span></p>

<p><img src="images/image6.png" alt="alt_text" title="image_tooltip" /></p>

<h2 id="using-variables-to-avoid-querying-data-multiple-times">Using variables to avoid querying data multiple times</h2>

<p>Rather than query data multiple times, store the result in a variable and reference it. In other words:</p>

<p><strong>Don‚Äôt</strong> do this:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">from</span><span class="p">(</span><span class="nx">bucket</span><span class="p">:</span> <span class="dl">"</span><span class="s2">my-bucket</span><span class="dl">"</span><span class="p">)</span>
<span class="o">|&gt;</span> <span class="nx">range</span><span class="p">(</span><span class="nx">start</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="nx">h</span><span class="p">)</span>
<span class="o">|&gt;</span> <span class="nx">filter</span><span class="p">(</span><span class="nx">fn</span><span class="p">:</span> <span class="p">(</span><span class="nx">r</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">r</span><span class="p">.</span><span class="nx">_measurement</span> <span class="o">==</span> <span class="dl">"</span><span class="s2">my_measurement</span><span class="dl">"</span><span class="p">)</span>
<span class="o">|&gt;</span> <span class="nx">mean</span><span class="p">()</span>
<span class="o">|&gt;</span> <span class="kd">set</span><span class="p">(</span><span class="nx">key</span><span class="p">:</span> <span class="dl">"</span><span class="s2">agg_type</span><span class="dl">"</span><span class="p">,</span><span class="nx">value</span><span class="p">:</span> <span class="dl">"</span><span class="s2">mean_temp</span><span class="dl">"</span><span class="p">)</span>
<span class="o">|&gt;</span> <span class="nx">to</span><span class="p">(</span><span class="nx">bucket</span><span class="p">:</span> <span class="dl">"</span><span class="s2">downsampled</span><span class="dl">"</span><span class="p">,</span> <span class="nx">org</span><span class="p">:</span> <span class="dl">"</span><span class="s2">my-org</span><span class="dl">"</span><span class="p">,</span> <span class="nx">tagColumns</span><span class="p">:[</span><span class="dl">"</span><span class="s2">agg_type</span><span class="dl">"</span><span class="p">])</span> 

<span class="k">from</span><span class="p">(</span><span class="nx">bucket</span><span class="p">:</span> <span class="dl">"</span><span class="s2">my-bucket</span><span class="dl">"</span><span class="p">)</span>
<span class="o">|&gt;</span> <span class="nx">range</span><span class="p">(</span><span class="nx">start</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="nx">h</span><span class="p">)</span>
<span class="o">|&gt;</span> <span class="nx">filter</span><span class="p">(</span><span class="nx">fn</span><span class="p">:</span> <span class="p">(</span><span class="nx">r</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">r</span><span class="p">.</span><span class="nx">_measurement</span> <span class="o">==</span> <span class="dl">"</span><span class="s2">my_measurement</span><span class="dl">"</span><span class="p">)</span>
<span class="o">|&gt;</span> <span class="nx">count</span><span class="p">()</span>
<span class="o">|&gt;</span> <span class="kd">set</span><span class="p">(</span><span class="nx">key</span><span class="p">:</span> <span class="dl">"</span><span class="s2">agg_type</span><span class="dl">"</span><span class="p">,</span><span class="nx">value</span><span class="p">:</span> <span class="dl">"</span><span class="s2">count_temp</span><span class="dl">"</span><span class="p">)</span>
<span class="o">|&gt;</span> <span class="nx">to</span><span class="p">(</span><span class="nx">bucket</span><span class="p">:</span> <span class="dl">"</span><span class="s2">downsampled</span><span class="dl">"</span><span class="p">,</span> <span class="nx">org</span><span class="p">:</span> <span class="dl">"</span><span class="s2">my-org</span><span class="dl">"</span><span class="p">,</span> <span class="nx">tagColumns</span><span class="p">:</span> <span class="p">[</span><span class="dl">"</span><span class="s2">agg_type</span><span class="dl">"</span><span class="p">])</span>
</code></pre></div></div>

<p><strong>Do</strong> this instead:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">data</span> <span class="o">=</span> <span class="k">from</span><span class="p">(</span><span class="nx">bucket</span><span class="p">:</span> <span class="dl">"</span><span class="s2">my-bucket</span><span class="dl">"</span><span class="p">)</span>
<span class="o">|&gt;</span> <span class="nx">range</span><span class="p">(</span><span class="nx">start</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="nx">h</span><span class="p">)</span>
<span class="o">|&gt;</span> <span class="nx">filter</span><span class="p">(</span><span class="nx">fn</span><span class="p">:</span> <span class="p">(</span><span class="nx">r</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">r</span><span class="p">.</span><span class="nx">_measurement</span> <span class="o">==</span> <span class="dl">"</span><span class="s2">my_measurement</span><span class="dl">"</span><span class="p">)</span>

<span class="nx">data</span>
<span class="o">|&gt;</span> <span class="nx">mean</span><span class="p">()</span>
<span class="o">|&gt;</span> <span class="kd">set</span><span class="p">(</span><span class="nx">key</span><span class="p">:</span> <span class="dl">"</span><span class="s2">agg_type</span><span class="dl">"</span><span class="p">,</span><span class="nx">value</span><span class="p">:</span> <span class="dl">"</span><span class="s2">mean_temp</span><span class="dl">"</span><span class="p">)</span>
<span class="o">|&gt;</span> <span class="nx">to</span><span class="p">(</span><span class="nx">bucket</span><span class="p">:</span> <span class="dl">"</span><span class="s2">downsampled</span><span class="dl">"</span><span class="p">,</span> <span class="nx">org</span><span class="p">:</span> <span class="dl">"</span><span class="s2">my-org</span><span class="dl">"</span><span class="p">,</span> <span class="nx">tagColumns</span><span class="p">:</span> <span class="p">[</span><span class="dl">"</span><span class="s2">agg_type</span><span class="dl">"</span><span class="p">])</span>

<span class="nx">data</span>
<span class="o">|&gt;</span> <span class="nx">count</span><span class="p">()</span>
<span class="o">|&gt;</span> <span class="kd">set</span><span class="p">(</span><span class="nx">key</span><span class="p">:</span> <span class="dl">"</span><span class="s2">agg_type</span><span class="dl">"</span><span class="p">,</span><span class="nx">value</span><span class="p">:</span> <span class="dl">"</span><span class="s2">count_temp</span><span class="dl">"</span><span class="p">)</span>
<span class="o">|&gt;</span> <span class="nx">to</span><span class="p">(</span><span class="nx">bucket</span><span class="p">:</span> <span class="dl">"</span><span class="s2">downsampled</span><span class="dl">"</span><span class="p">,</span> <span class="nx">org</span><span class="p">:</span> <span class="dl">"</span><span class="s2">my-org</span><span class="dl">"</span><span class="p">,</span> <span class="nx">tagColumns</span><span class="p">:</span> <span class="p">[</span><span class="dl">"</span><span class="s2">agg_type</span><span class="dl">"</span><span class="p">])</span>
</code></pre></div></div>

<h2 id="dividing-processing-work-across-multiple-tasks">Dividing processing work across multiple tasks</h2>

<p>Are you trying to perform schema mutations, pivots, joins, complex math, and mappings all in the same task? If you are and you‚Äôre experiencing a long execution time, consider splitting up some of this work across multiple tasks instead. Separating the processing work out and executing these tasks in parallel can help you reduce your overall execution time.</p>

<h2 id="the-flux-profiler-package">The Flux Profiler package</h2>

<p>The <a href="https://docs.influxdata.com/influxdb/cloud/reference/flux/stdlib/profiler/">Flux Profiler package</a> provides performance information based on your query. As per the documentation, the following Flux query:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="dl">"</span><span class="s2">profiler</span><span class="dl">"</span>

<span class="nx">option</span> <span class="nx">profiler</span><span class="p">.</span><span class="nx">enabledProfilers</span> <span class="o">=</span> <span class="p">[</span><span class="dl">"</span><span class="s2">query</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">operator</span><span class="dl">"</span><span class="p">]</span>

<span class="k">from</span><span class="p">(</span><span class="nx">bucket</span><span class="p">:</span> <span class="dl">"</span><span class="s2">noaa</span><span class="dl">"</span><span class="p">)</span>
  <span class="o">|&gt;</span> <span class="nx">range</span><span class="p">(</span><span class="nx">start</span><span class="p">:</span> <span class="mi">2019</span><span class="o">-</span><span class="mi">08</span><span class="o">-</span><span class="mi">17</span><span class="nx">T00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="nx">Z</span><span class="p">,</span> <span class="nx">stop</span><span class="p">:</span> <span class="mi">2019</span><span class="o">-</span><span class="mi">08</span><span class="o">-</span><span class="mi">17</span><span class="nx">T00</span><span class="p">:</span><span class="mi">30</span><span class="p">:</span><span class="mi">00</span><span class="nx">Z</span><span class="p">)</span>
  <span class="o">|&gt;</span> <span class="nx">filter</span><span class="p">(</span><span class="nx">fn</span><span class="p">:</span> <span class="p">(</span><span class="nx">r</span><span class="p">)</span> <span class="o">=&gt;</span>
    <span class="nx">r</span><span class="p">.</span><span class="nx">_measurement</span> <span class="o">==</span> <span class="dl">"</span><span class="s2">h2o_feet</span><span class="dl">"</span> <span class="nx">and</span>
    <span class="nx">r</span><span class="p">.</span><span class="nx">_field</span> <span class="o">==</span> <span class="dl">"</span><span class="s2">water_level</span><span class="dl">"</span> <span class="nx">and</span>
    <span class="nx">r</span><span class="p">.</span><span class="nx">location</span> <span class="o">==</span> <span class="dl">"</span><span class="s2">coyote_creek</span><span class="dl">"</span>
  <span class="p">)</span>
  <span class="o">|&gt;</span> <span class="nx">map</span><span class="p">(</span><span class="nx">fn</span><span class="p">:</span> <span class="p">(</span><span class="nx">r</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">({</span> <span class="nx">r</span> <span class="kd">with</span>
    <span class="na">_value</span><span class="p">:</span> <span class="nx">r</span><span class="p">.</span><span class="nx">_value</span> <span class="o">*</span> <span class="mf">12.0</span><span class="p">,</span>
    <span class="na">_measurement</span><span class="p">:</span> <span class="dl">"</span><span class="s2">h2o_inches</span><span class="dl">"</span>
  <span class="p">}))</span>
  <span class="o">|&gt;</span> <span class="nx">drop</span><span class="p">(</span><span class="nx">columns</span><span class="p">:</span> <span class="p">[</span><span class="dl">"</span><span class="s2">_start</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">_stop</span><span class="dl">"</span><span class="p">])</span>
</code></pre></div></div>

<p>Yields the following tables from the Profiler:</p>

<p><img src="/time-to-awesome/assets/images/image-27.png" alt="" /></p>

<p>The Flux Profiler outputs performance information about your query in nanoseconds.</p>

<ul>
  <li>The first table provides information about your entire query including the total duration time it took to execute the query as well as the time it spent compiling, in the queue, etc.</li>
  <li>The second table provides information about where the query is spending the most amount of time.</li>
</ul>

<p>The two most important columns to pay attention to are the TotalDuration column from the first table and the DurationSum column from the second table. This query is executed very quickly, so I don‚Äôt have to worry about optimizing it. However, I‚Äôll describe the thought process for optimizing it further.</p>

<p>First I would try to identify which part of the query is taking the longest to execute. From the query above, we can see that the merged_ReadRange5_filter operation has the largest DurationSum of 529282 ns. If I was planning to convert this query to a task and perform this transformation work on a schedule, the first thing I should consider is querying data over a shorter range and running the task more frequently.</p>

<p>Next, I notice that the <a href="https://docs.influxdata.com/influxdb/cloud/reference/flux/stdlib/built-in/transformations/map/">map()</a> function contributes the second longest DurationSum value. Taking a look back at my <a href="https://docs.influxdata.com/influxdb/cloud/reference/flux/stdlib/built-in/transformations/map/">map()</a> function, I have to wonder if renaming the measurement with <a href="https://docs.influxdata.com/influxdb/cloud/reference/flux/stdlib/built-in/transformations/map/">map()</a> is the most efficient way. Perhaps I should try using the <a href="https://docs.influxdata.com/influxdb/cloud/reference/flux/stdlib/built-in/transformations/set/">set()</a> function instead like so:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">from</span><span class="p">(</span><span class="nx">bucket</span><span class="p">:</span> <span class="dl">"</span><span class="s2">noaa</span><span class="dl">"</span><span class="p">)</span>
  <span class="o">|&gt;</span> <span class="nx">range</span><span class="p">(</span><span class="nx">start</span><span class="p">:</span> <span class="mi">2019</span><span class="o">-</span><span class="mi">08</span><span class="o">-</span><span class="mi">17</span><span class="nx">T00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="nx">Z</span><span class="p">,</span> <span class="nx">stop</span><span class="p">:</span> <span class="mi">2019</span><span class="o">-</span><span class="mi">08</span><span class="o">-</span><span class="mi">17</span><span class="nx">T00</span><span class="p">:</span><span class="mi">30</span><span class="p">:</span><span class="mi">00</span><span class="nx">Z</span><span class="p">)</span>
  <span class="o">|&gt;</span> <span class="nx">filter</span><span class="p">(</span><span class="nx">fn</span><span class="p">:</span> <span class="p">(</span><span class="nx">r</span><span class="p">)</span> <span class="o">=&gt;</span>
    <span class="nx">r</span><span class="p">.</span><span class="nx">_measurement</span> <span class="o">==</span> <span class="dl">"</span><span class="s2">h2o_feet</span><span class="dl">"</span> <span class="nx">and</span>
    <span class="nx">r</span><span class="p">.</span><span class="nx">_field</span> <span class="o">==</span> <span class="dl">"</span><span class="s2">water_level</span><span class="dl">"</span> <span class="nx">and</span>
    <span class="nx">r</span><span class="p">.</span><span class="nx">location</span> <span class="o">==</span> <span class="dl">"</span><span class="s2">coyote_creek</span><span class="dl">"</span>
  <span class="p">)</span>
 <span class="o">|&gt;</span> <span class="nx">drop</span><span class="p">(</span><span class="nx">columns</span><span class="p">:</span> <span class="p">[</span><span class="dl">"</span><span class="s2">_start</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">_stop</span><span class="dl">"</span><span class="p">])</span>
  <span class="o">|&gt;</span> <span class="kd">set</span><span class="p">(</span><span class="nx">key</span><span class="p">:</span> <span class="dl">"</span><span class="s2">_measurement</span><span class="dl">"</span><span class="p">,</span><span class="nx">value</span><span class="p">:</span> <span class="dl">"</span><span class="s2">h2o_inches</span><span class="dl">"</span><span class="p">)</span>
  <span class="o">|&gt;</span> <span class="nx">map</span><span class="p">(</span><span class="nx">fn</span><span class="p">:</span> <span class="p">(</span><span class="nx">r</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">({</span> <span class="nx">r</span> <span class="kd">with</span>
    <span class="na">_value</span><span class="p">:</span> <span class="nx">r</span><span class="p">.</span><span class="nx">_value</span> <span class="o">*</span> <span class="mf">12.0</span><span class="p">,</span>
  <span class="p">}))</span>
</code></pre></div></div>

<p>Also notice that I switch the order of the functions and apply <a href="https://docs.influxdata.com/influxdb/cloud/reference/flux/stdlib/built-in/transformations/drop/">drop()</a> and <a href="https://docs.influxdata.com/influxdb/cloud/reference/flux/stdlib/built-in/transformations/set/">set()</a> functions before the <a href="https://docs.influxdata.com/influxdb/cloud/reference/flux/stdlib/built-in/transformations/map/">map()</a> function. After running the Profiler, I see a decrease in the TotalDuration time which indicates that these were all good changes. Since performance optimizations are continuously made to Flux and everyone‚Äôs schema is very different, there aren‚Äôt hard rules for Flux performance optimization. Instead, I encourage you to take advantage of the Profiler and perform some experimentation to find solutions that work best for you.</p>

<h2 id="using-the-flux-extension-for-visual-studio-code-to-streamline-flux-optimization-discovery">Using the Flux extension for Visual Studio Code to streamline Flux optimization discovery</h2>

<p>If you haven‚Äôt given it a try already, I encourage you to install the <a href="https://marketplace.visualstudio.com/items?itemName=influxdata.flux">Flux extension</a> for <a href="https://www.google.com/search?q=visual+studio+code&amp;oq=visual+stu&amp;aqs=chrome.1.0i433l2j69i57j0i433j0j0i433j69i60j69i61.2304j1j7&amp;sourceid=chrome&amp;ie=UTF-8">Visual Studio Code</a>. To query your InfluxDB Cloud account with the Flux extension, you must first configure it and <a href="https://docs.influxdata.com/influxdb/v2.0/tools/flux-vscode/#connect-to-influxdb">connect to your cloud account</a>. I enjoy using the Flux extension and VS Code when trying to debug complicated Flux scripts or trying to optimize the performance of my Flux scripts because I can save my Flux scripts and compare outputs from the Profiler simultaneously.</p>

<p id="gdcalert15"><span style="color: red; font-weight: bold">&gt;&gt;&gt;&gt;&gt;  gd2md-html alert: inline image link here (to images/image8.png). Store image on your image server and adjust path/filename/extension if necessary. </span><br />(<a href="#">Back to top</a>)(<a href="#gdcalert16">Next alert</a>)<br /><span style="color: red; font-weight: bold">&gt;&gt;&gt;&gt;&gt; </span></p>

<p><img src="images/image8.png" alt="alt_text" title="image_tooltip" />
The original ‚Äúbad_join‚Äù query (red) is commented out because I ran it first. Its TotalDuration time was 17608617 ns. Joining on multiple like-columns and removing the drop() improves the performance to 14160858 ns.</p>

<p>I decided to test the queries described in the ‚ÄúUsing schema mutations properly‚Äù section above. The Profiler confirms my hypothesis: joining on multiple like-columns is more efficient than dropping redundant ones retroactively. While you can also perform this work in the InfluxDB UI, I find the side-by-side comparison of Profiler outputs helpful for this type of experimentation.</p>

<h2 id="other-tips">Other tips</h2>

<p>Here are a list of other substitutions or ideas to consider when trying to optimize the performance of your Flux query:</p>

<ol>
  <li>Can you use the <a href="https://docs.influxdata.com/influxdb/cloud/reference/flux/stdlib/experimental/join/">experimental.join()</a> function instead of <a href="https://docs.influxdata.com/influxdb/cloud/reference/flux/stdlib/built-in/transformations/join/">join()</a> function?</li>
  <li>Can you apply any groups that will reduce the number of rows in your table(s) before applying a <a href="https://docs.influxdata.com/influxdb/cloud/reference/flux/stdlib/built-in/transformations/map/">map()</a> function?</li>
  <li>Can you tune any regexes to be as specific as possible?</li>
  <li>Can you use rows.map() instead of map()?</li>
  <li>Does<code class="language-plaintext highlighter-rouge"> |&gt; sort(columns: ["_time"], desc: false) |&gt; limit(n:1)</code> perform better than<code class="language-plaintext highlighter-rouge"> |&gt; last()</code>?</li>
</ol>

<h2 id="best-practices-for-receiving-help">Best practices for receiving help</h2>

<p>When asking for help with optimizing the performance of your Flux script, whether it‚Äôs on the <a href="https://community.influxdata.com/">community forums</a>, <a href="https://influxdata.com/slack">Slack</a>, or through <a href="https://support.influxdata.com/s/">support</a>, please include the following information in your post or request:</p>

<ul>
  <li>What is the query that‚Äôs having an issue?
    <ul>
      <li>Make sure to share it as well as including the output from the Profiler.</li>
    </ul>
  </li>
  <li>What is the cardinality of your data? (how many series)
    <ul>
      <li>Try using the <a href="https://github.com/influxdata/community-templates/tree/master/influxdb2_operational_monitoring">InfluxDB Operational Monitoring Template</a> to help you find the cardinality of your data.</li>
      <li>Alternatively try using the <a href="https://docs.influxdata.com/influxdb/v2.0/reference/flux/stdlib/influxdb/cardinality/">schema.cardinality()</a> function to help you find the cardinality of your data.</li>
    </ul>
  </li>
  <li>What is the density of your data? (how many points per unit time in each series)
    <ul>
      <li>Try using the <a href="https://github.com/influxdata/community-templates/tree/master/usage_dashboard">InfluxDB Cloud Usage Template</a> to help you identify the data into your InfluxDB Cloud account.</li>
    </ul>
  </li>
  <li>General information about how your data is structured (which measurements, fields and tag keys exist) is always helpful.
    <ul>
      <li>Try using the <a href="https://docs.influxdata.com/influxdb/cloud/reference/flux/stdlib/influxdb-schema/">schema package</a> to share your data structure.</li>
    </ul>
  </li>
  <li>What is your expectation of how fast a query should run? What‚Äôs the basis for that expectation?</li>
</ul>

<p>Including as much of this information in a post will help us assist you better and more quickly. The above points also apply to issues with hitting memory limits.</p>

<p><a href="/time-to-awesome/docs/part-2/part-3" class="btn btn-purple">Part 3</a></p>
:ET