<!DOCTYPE html><html lang="en-US"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=Edge"><link rel="shortcut icon" href="/time-to-awesome/favicon.ico" type="image/x-icon"><link rel="stylesheet" href="/time-to-awesome/assets/css/just-the-docs-default.css"> <script async src="https://www.googletagmanager.com/gtag/js?id=UA-2709176-10"></script> <script> window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'UA-2709176-10', { 'anonymize_ip': true }); </script> <script type="text/javascript" src="/time-to-awesome/assets/js/vendor/lunr.min.js"></script> <script type="text/javascript" src="/time-to-awesome/assets/js/just-the-docs.js"></script><meta name="viewport" content="width=device-width, initial-scale=1"><title>Optimizing Flux Performance | Time to Awesome</title><meta name="generator" content="Jekyll v4.2.1" /><meta property="og:title" content="Optimizing Flux Performance" /><meta property="og:locale" content="en_US" /><meta name="description" content="A Jekyll theme for documentation" /><meta property="og:description" content="A Jekyll theme for documentation" /><link rel="canonical" href="http://localhost:4000/time-to-awesome/docs/part-2/optimizing-flux-performance/" /><meta property="og:url" content="http://localhost:4000/time-to-awesome/docs/part-2/optimizing-flux-performance/" /><meta property="og:site_name" content="Time to Awesome" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Optimizing Flux Performance" /> <script type="application/ld+json"> {"description":"A Jekyll theme for documentation","headline":"Optimizing Flux Performance","url":"http://localhost:4000/time-to-awesome/docs/part-2/optimizing-flux-performance/","@type":"WebPage","@context":"https://schema.org"}</script><body> <svg xmlns="http://www.w3.org/2000/svg" style="display: none;"> <symbol id="svg-link" viewBox="0 0 24 24"><title>Link</title><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-link"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path> </svg> </symbol> <symbol id="svg-search" viewBox="0 0 24 24"><title>Search</title><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-search"> <circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line> </svg> </symbol> <symbol id="svg-menu" viewBox="0 0 24 24"><title>Menu</title><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line> </svg> </symbol> <symbol id="svg-arrow-right" viewBox="0 0 24 24"><title>Expand</title><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-right"><polyline points="9 18 15 12 9 6"></polyline> </svg> </symbol> <symbol id="svg-doc" viewBox="0 0 24 24"><title>Document</title><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file"><path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path><polyline points="13 2 13 9 20 9"></polyline> </svg> </symbol> </svg><div class="side-bar"><div class="site-header"> <a href="http://localhost:4000/time-to-awesome/" class="site-title lh-tight"> Time to Awesome </a> <a href="#" id="menu-button" class="site-button"> <svg viewBox="0 0 24 24" class="icon"><use xlink:href="#svg-menu"></use></svg> </a></div><nav role="navigation" aria-label="Main" id="site-nav" class="site-nav"><ul class="nav-list"><li class="nav-list-item"><a href="http://localhost:4000/time-to-awesome/" class="nav-list-link">Home</a><li class="nav-list-item"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="http://localhost:4000/time-to-awesome/docs/part-1" class="nav-list-link">Part 1</a><ul class="nav-list "><li class="nav-list-item "><a href="http://localhost:4000/time-to-awesome/docs/part-1/introduction-to-influxdb/" class="nav-list-link">Introduction to InfluxDB</a><li class="nav-list-item "><a href="http://localhost:4000/time-to-awesome/docs/part-1/introduction-to-influxdb-tools/" class="nav-list-link">Introduction to InfluxDB Tools</a><li class="nav-list-item "><a href="http://localhost:4000/time-to-awesome/docs/part-1/setting-up-influxdb/" class="nav-list-link">Setting Up InfluxDB</a></ul><li class="nav-list-item active"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="http://localhost:4000/time-to-awesome/docs/part-2" class="nav-list-link">Part 2</a><ul class="nav-list "><li class="nav-list-item "><a href="http://localhost:4000/time-to-awesome/docs/part-2/influxdb-data-model/" class="nav-list-link">InfluxDB Data Model</a><li class="nav-list-item "><a href="http://localhost:4000/time-to-awesome/docs/part-2/input-format-vs-output-format/" class="nav-list-link">Input Format vs Output Format</a><li class="nav-list-item "><a href="http://localhost:4000/time-to-awesome/docs/part-2/designing-your-schema/" class="nav-list-link">Designing Your Schema</a><li class="nav-list-item "><a href="http://localhost:4000/time-to-awesome/docs/part-2/introduction-to-flux/" class="nav-list-link">Introduction to Flux</a><li class="nav-list-item "><a href="http://localhost:4000/time-to-awesome/docs/part-2/querying-and-data-transformations/" class="nav-list-link">Querying and Data Transformations</a><li class="nav-list-item "><a href="http://localhost:4000/time-to-awesome/docs/part-2/deletes/" class="nav-list-link">Deletes</a><li class="nav-list-item active"><a href="http://localhost:4000/time-to-awesome/docs/part-2/optimizing-flux-performance/" class="nav-list-link active">Optimizing Flux Performance</a></ul><li class="nav-list-item"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="http://localhost:4000/time-to-awesome/docs/part-3" class="nav-list-link">Part 3</a><ul class="nav-list "></ul></ul></nav><footer class="site-footer"> This site uses <a href="https://github.com/pmarsceill/just-the-docs">Just the Docs</a>, a documentation theme for Jekyll.</footer></div><div class="main" id="top"><div id="main-header" class="main-header"><div class="search"><div class="search-input-wrap"> <input type="text" id="search-input" class="search-input" tabindex="0" placeholder="Search Time to Awesome" aria-label="Search Time to Awesome" autocomplete="off"> <label for="search-input" class="search-label"><svg viewBox="0 0 24 24" class="search-icon"><use xlink:href="#svg-search"></use></svg></label></div><div id="search-results" class="search-results"></div></div><nav aria-label="Auxiliary" class="aux-nav"><ul class="aux-nav-list"><li class="aux-nav-list-item"> <a href="//github.com/influxdata/book.github.io" class="site-button" > Time to Awesome on GitHub </a></ul></nav></div><div id="main-content-wrap" class="main-content-wrap"><nav aria-label="Breadcrumb" class="breadcrumb-nav"><ol class="breadcrumb-nav-list"><li class="breadcrumb-nav-list-item"><a href="http://localhost:4000/time-to-awesome/docs/part-2">Part 2</a><li class="breadcrumb-nav-list-item"><span>Optimizing Flux Performance</span></ol></nav><div id="main-content" class="main-content" role="main"><h1 class="no_toc" id="optimizing-flux-performance"> <a href="#optimizing-flux-performance" class="anchor-heading" aria-labelledby="optimizing-flux-performance"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Optimizing Flux Performance</h1><h2 class="no_toc text-delta" id="table-of-contents"> <a href="#table-of-contents" class="anchor-heading" aria-labelledby="table-of-contents"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Table of contents</h2><ol id="markdown-toc"><li><a href="#optimizing-flux-performance-1" id="markdown-toc-optimizing-flux-performance-1">Optimizing Flux Performance</a><ol><li><a href="#general-recommendations-for-flux-performance-optimization" id="markdown-toc-general-recommendations-for-flux-performance-optimization">General recommendations for Flux performance optimization</a><li><a href="#taking-advantage-of-pushdown-patterns" id="markdown-toc-taking-advantage-of-pushdown-patterns">Taking advantage of pushdown patterns</a><li><a href="#using-schema-mutations-properly" id="markdown-toc-using-schema-mutations-properly">Using schema mutations properly</a><li><a href="#using-variables-to-avoid-querying-data-multiple-times" id="markdown-toc-using-variables-to-avoid-querying-data-multiple-times">Using variables to avoid querying data multiple times</a><li><a href="#dividing-processing-work-across-multiple-tasks" id="markdown-toc-dividing-processing-work-across-multiple-tasks">Dividing processing work across multiple tasks</a><li><a href="#the-flux-profiler-package" id="markdown-toc-the-flux-profiler-package">The Flux Profiler package</a><li><a href="#using-the-flux-extension-for-visual-studio-code-to-streamline-flux-optimization-discovery" id="markdown-toc-using-the-flux-extension-for-visual-studio-code-to-streamline-flux-optimization-discovery">Using the Flux extension for Visual Studio Code to streamline Flux optimization discovery</a><li><a href="#other-tips" id="markdown-toc-other-tips">Other tips</a><li><a href="#best-practices-for-receiving-help" id="markdown-toc-best-practices-for-receiving-help">Best practices for receiving help</a></ol></ol><hr /><h1 id="optimizing-flux-performance-1"> <a href="#optimizing-flux-performance-1" class="anchor-heading" aria-labelledby="optimizing-flux-performance-1"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Optimizing Flux Performance</h1><p>So you’re using InfluxDB Cloud and you’re taking full advantage of Flux to create custom data processing tasks, checks, and notifications. However, you notice that some of your Flux scripts aren’t executing as quickly as you expect. In this section, we’ll learn about best practices and tools for optimizing Flux performance.</p><h2 id="general-recommendations-for-flux-performance-optimization"> <a href="#general-recommendations-for-flux-performance-optimization" class="anchor-heading" aria-labelledby="general-recommendations-for-flux-performance-optimization"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> General recommendations for Flux performance optimization</h2><p>Before diving into some of the tools you can use to optimize Flux performance, let’s dive into some general recommendations for Flux performance optimization:</p><ol><li>Take advantage of pushdown patterns.<li>Schema mutation functions should be applied at the end of your query.<li>Use variables to avoid querying data multiple times.<li>Divide processing work across multiple tasks when needed.</ol><p>We’ll discuss each of these recommendations in detail in the following sections.</p><h2 id="taking-advantage-of-pushdown-patterns"> <a href="#taking-advantage-of-pushdown-patterns" class="anchor-heading" aria-labelledby="taking-advantage-of-pushdown-patterns"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Taking advantage of pushdown patterns</h2><p>In order to provide context for the optimization guidelines, let’s first take a moment to understand how Flux works. Flux is able to query data efficiently because some functions push down the data transformation workload to storage rather than performing the transformations in memory. Combinations of functions that do this work are called pushdown patterns. It’s best to try and use pushdown patterns whenever you can optimize your Flux query. To learn more about pushdown patterns and how Flux works, please read “Solution 2: Learning about memory optimizations and new pushdown patterns to optimize your Flux scripts” from <a href="https://www.influxdata.com/blog/top-5-hurdles-for-intermediate-flux-users-and-resources-for-optimizing-flux/">Top 5 Hurdles for Intermediate Flux Users and Resources for Optimizing Flux</a>.</p><h2 id="using-schema-mutations-properly"> <a href="#using-schema-mutations-properly" class="anchor-heading" aria-labelledby="using-schema-mutations-properly"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Using schema mutations properly</h2><p>Schema mutation functions are any functions that change the columns in your Flux tables. They include functions like <a href="https://docs.influxdata.com/influxdb/cloud/reference/flux/stdlib/built-in/transformations/keep/">keep()</a>, <a href="https://docs.influxdata.com/influxdb/cloud/reference/flux/stdlib/built-in/transformations/drop/">drop()</a>, <a href="https://docs.influxdata.com/influxdb/cloud/reference/flux/stdlib/built-in/transformations/rename/">rename()</a>, <a href="https://docs.influxdata.com/influxdb/cloud/reference/flux/stdlib/built-in/transformations/duplicate/">duplicate()</a>, and <a href="https://docs.influxdata.com/influxdb/cloud/reference/flux/stdlib/built-in/transformations/set/">set()</a>. If you’re using an <a href="https://docs.influxdata.com/influxdb/cloud/reference/flux/stdlib/built-in/transformations/aggregates/">aggregates</a> or <a href="https://docs.influxdata.com/influxdb/cloud/reference/flux/stdlib/built-in/transformations/selectors/">selector</a> function in your query, try to include the schema mutation functions after applying aggregation functions to preserve any pushdown patterns that you might have. Additionally, try replacing <a href="https://docs.influxdata.com/influxdb/cloud/reference/flux/stdlib/built-in/transformations/keep/">keep()</a> or <a href="https://docs.influxdata.com/influxdb/cloud/reference/flux/stdlib/built-in/transformations/drop/">drop()</a> with changes to the group key whenever possible. For example, when executing a <a href="https://docs.influxdata.com/influxdb/cloud/reference/flux/stdlib/built-in/transformations/join/">join()</a> across two fields from two buckets, join on all the like-columns instead of dropping the columns afterwards. We generate the data for this example with the <a href="https://docs.influxdata.com/influxdb/cloud/reference/flux/stdlib/array/from/">array.from()</a> function:</p><div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="dl">"</span><span class="s2">array</span><span class="dl">"</span>
<span class="k">import</span> <span class="dl">"</span><span class="s2">experimental</span><span class="dl">"</span>
<span class="nx">start</span> <span class="o">=</span> <span class="nx">experimental</span><span class="p">.</span><span class="nx">subDuration</span><span class="p">(</span>
<span class="nx">d</span><span class="p">:</span> <span class="o">-</span><span class="mi">10</span><span class="nx">m</span><span class="p">,</span>
<span class="k">from</span><span class="p">:</span> <span class="nx">now</span><span class="p">(),</span>
<span class="p">)</span>
<span class="nx">bucket1</span> <span class="o">=</span> <span class="nx">array</span><span class="p">.</span><span class="k">from</span><span class="p">(</span><span class="nx">rows</span><span class="p">:</span> <span class="p">[{</span><span class="na">_start</span><span class="p">:</span> <span class="nx">start</span><span class="p">,</span> <span class="na">_stop</span><span class="p">:</span> <span class="nx">now</span><span class="p">(),</span> <span class="na">_time</span><span class="p">:</span> <span class="nx">now</span><span class="p">(),</span><span class="na">_measurement</span><span class="p">:</span> <span class="dl">"</span><span class="s2">mymeas</span><span class="dl">"</span><span class="p">,</span> <span class="na">_field</span><span class="p">:</span> <span class="dl">"</span><span class="s2">myfield</span><span class="dl">"</span><span class="p">,</span> <span class="na">_value</span><span class="p">:</span> <span class="dl">"</span><span class="s2">foo1</span><span class="dl">"</span><span class="p">}])</span>
<span class="o">|&gt;</span> <span class="k">yield</span><span class="p">(</span><span class="nx">name</span><span class="p">:</span> <span class="dl">"</span><span class="s2">bucket1</span><span class="dl">"</span><span class="p">)</span>


<span class="nx">bucket2</span> <span class="o">=</span> <span class="nx">array</span><span class="p">.</span><span class="k">from</span><span class="p">(</span><span class="nx">rows</span><span class="p">:</span> <span class="p">[{</span><span class="na">_start</span><span class="p">:</span> <span class="nx">start</span><span class="p">,</span> <span class="na">_stop</span><span class="p">:</span> <span class="nx">now</span><span class="p">(),</span> <span class="na">_time</span><span class="p">:</span> <span class="nx">now</span><span class="p">(),</span><span class="na">_measurement</span><span class="p">:</span> <span class="dl">"</span><span class="s2">mymeas</span><span class="dl">"</span><span class="p">,</span> <span class="na">_field</span><span class="p">:</span> <span class="dl">"</span><span class="s2">myfield</span><span class="dl">"</span><span class="p">,</span> <span class="na">_value</span><span class="p">:</span> <span class="dl">"</span><span class="s2">foo2</span><span class="dl">"</span><span class="p">}])</span>
<span class="o">|&gt;</span> <span class="k">yield</span><span class="p">(</span><span class="nx">name</span><span class="p">:</span> <span class="dl">"</span><span class="s2">bucket2</span><span class="dl">"</span><span class="p">)</span>
</code></pre></div></div><p>The <a href="https://docs.influxdata.com/influxdb/cloud/reference/syntax/annotated-csv/">annotated CSV</a> output from our query looks like this:</p><p><img src="/time-to-awesome/assets/images/image-30.png" alt="ui" /></p><p><strong>Don’t</strong> use drop() unnecessarily after a join():</p><div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">join</span><span class="p">(</span><span class="nx">tables</span><span class="p">:</span> <span class="p">{</span><span class="nl">bucket1</span><span class="p">:</span> <span class="nx">bucket1</span><span class="p">,</span> <span class="nx">bucket2</span><span class="p">:</span> <span class="nx">bucket2</span><span class="p">},</span> <span class="nx">on</span><span class="p">:</span> <span class="p">[</span><span class="dl">"</span><span class="s2">_time</span><span class="dl">"</span><span class="p">],</span> <span class="nx">method</span><span class="p">:</span> <span class="dl">"</span><span class="s2">inner</span><span class="dl">"</span><span class="p">)</span>
<span class="o">|&gt;</span> <span class="nx">drop</span><span class="p">(</span><span class="nx">columns</span><span class="p">:[</span><span class="dl">"</span><span class="s2">_start_field1</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">_stop_field1</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">_measurement_field1</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">myfield1</span><span class="dl">"</span><span class="p">])</span>
<span class="o">|&gt;</span> <span class="k">yield</span><span class="p">(</span><span class="nx">name</span><span class="p">:</span> <span class="dl">"</span><span class="s2">bad_join</span><span class="dl">"</span><span class="p">)</span>
</code></pre></div></div><p><strong>Do</strong> replace with changes to the group key by joining on like-columns:</p><div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">join</span><span class="p">(</span><span class="nx">tables</span><span class="p">:</span> <span class="p">{</span><span class="nl">bucket1</span><span class="p">:</span> <span class="nx">bucket1</span><span class="p">,</span> <span class="nx">bucket2</span><span class="p">:</span> <span class="nx">bucket2</span><span class="p">},</span> <span class="nx">on</span><span class="p">:</span> <span class="p">[</span><span class="dl">"</span><span class="s2">_start</span><span class="dl">"</span><span class="p">,</span><span class="dl">"</span><span class="s2">_stop</span><span class="dl">""</span><span class="s2">_time</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">_measurement</span><span class="dl">"</span><span class="p">,</span><span class="dl">"</span><span class="s2">_field</span><span class="dl">"</span><span class="p">],</span> <span class="nx">method</span><span class="p">:</span> <span class="dl">"</span><span class="s2">inner</span><span class="dl">"</span><span class="p">)</span>
<span class="o">|&gt;</span> <span class="k">yield</span><span class="p">(</span><span class="nx">name</span><span class="p">:</span> <span class="dl">"</span><span class="s2">good_join</span><span class="dl">"</span><span class="p">)</span>
</code></pre></div></div><p>To yield the same result:</p><p><img src="/time-to-awesome/assets/images/image-31.png" alt="ui" /></p><h2 id="using-variables-to-avoid-querying-data-multiple-times"> <a href="#using-variables-to-avoid-querying-data-multiple-times" class="anchor-heading" aria-labelledby="using-variables-to-avoid-querying-data-multiple-times"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Using variables to avoid querying data multiple times</h2><p>Rather than query data multiple times, store the result in a variable and reference it. In other words:</p><p><strong>Don’t</strong> do this:</p><div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">from</span><span class="p">(</span><span class="nx">bucket</span><span class="p">:</span> <span class="dl">"</span><span class="s2">my-bucket</span><span class="dl">"</span><span class="p">)</span>
<span class="o">|&gt;</span> <span class="nx">range</span><span class="p">(</span><span class="nx">start</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="nx">h</span><span class="p">)</span>
<span class="o">|&gt;</span> <span class="nx">filter</span><span class="p">(</span><span class="nx">fn</span><span class="p">:</span> <span class="p">(</span><span class="nx">r</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">r</span><span class="p">.</span><span class="nx">_measurement</span> <span class="o">==</span> <span class="dl">"</span><span class="s2">my_measurement</span><span class="dl">"</span><span class="p">)</span>
<span class="o">|&gt;</span> <span class="nx">mean</span><span class="p">()</span>
<span class="o">|&gt;</span> <span class="kd">set</span><span class="p">(</span><span class="nx">key</span><span class="p">:</span> <span class="dl">"</span><span class="s2">agg_type</span><span class="dl">"</span><span class="p">,</span><span class="nx">value</span><span class="p">:</span> <span class="dl">"</span><span class="s2">mean_temp</span><span class="dl">"</span><span class="p">)</span>
<span class="o">|&gt;</span> <span class="nx">to</span><span class="p">(</span><span class="nx">bucket</span><span class="p">:</span> <span class="dl">"</span><span class="s2">downsampled</span><span class="dl">"</span><span class="p">,</span> <span class="nx">org</span><span class="p">:</span> <span class="dl">"</span><span class="s2">my-org</span><span class="dl">"</span><span class="p">,</span> <span class="nx">tagColumns</span><span class="p">:[</span><span class="dl">"</span><span class="s2">agg_type</span><span class="dl">"</span><span class="p">])</span> 

<span class="k">from</span><span class="p">(</span><span class="nx">bucket</span><span class="p">:</span> <span class="dl">"</span><span class="s2">my-bucket</span><span class="dl">"</span><span class="p">)</span>
<span class="o">|&gt;</span> <span class="nx">range</span><span class="p">(</span><span class="nx">start</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="nx">h</span><span class="p">)</span>
<span class="o">|&gt;</span> <span class="nx">filter</span><span class="p">(</span><span class="nx">fn</span><span class="p">:</span> <span class="p">(</span><span class="nx">r</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">r</span><span class="p">.</span><span class="nx">_measurement</span> <span class="o">==</span> <span class="dl">"</span><span class="s2">my_measurement</span><span class="dl">"</span><span class="p">)</span>
<span class="o">|&gt;</span> <span class="nx">count</span><span class="p">()</span>
<span class="o">|&gt;</span> <span class="kd">set</span><span class="p">(</span><span class="nx">key</span><span class="p">:</span> <span class="dl">"</span><span class="s2">agg_type</span><span class="dl">"</span><span class="p">,</span><span class="nx">value</span><span class="p">:</span> <span class="dl">"</span><span class="s2">count_temp</span><span class="dl">"</span><span class="p">)</span>
<span class="o">|&gt;</span> <span class="nx">to</span><span class="p">(</span><span class="nx">bucket</span><span class="p">:</span> <span class="dl">"</span><span class="s2">downsampled</span><span class="dl">"</span><span class="p">,</span> <span class="nx">org</span><span class="p">:</span> <span class="dl">"</span><span class="s2">my-org</span><span class="dl">"</span><span class="p">,</span> <span class="nx">tagColumns</span><span class="p">:</span> <span class="p">[</span><span class="dl">"</span><span class="s2">agg_type</span><span class="dl">"</span><span class="p">])</span>
</code></pre></div></div><p><strong>Do</strong> this instead:</p><div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">data</span> <span class="o">=</span> <span class="k">from</span><span class="p">(</span><span class="nx">bucket</span><span class="p">:</span> <span class="dl">"</span><span class="s2">my-bucket</span><span class="dl">"</span><span class="p">)</span>
<span class="o">|&gt;</span> <span class="nx">range</span><span class="p">(</span><span class="nx">start</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="nx">h</span><span class="p">)</span>
<span class="o">|&gt;</span> <span class="nx">filter</span><span class="p">(</span><span class="nx">fn</span><span class="p">:</span> <span class="p">(</span><span class="nx">r</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">r</span><span class="p">.</span><span class="nx">_measurement</span> <span class="o">==</span> <span class="dl">"</span><span class="s2">my_measurement</span><span class="dl">"</span><span class="p">)</span>

<span class="nx">data</span>
<span class="o">|&gt;</span> <span class="nx">mean</span><span class="p">()</span>
<span class="o">|&gt;</span> <span class="kd">set</span><span class="p">(</span><span class="nx">key</span><span class="p">:</span> <span class="dl">"</span><span class="s2">agg_type</span><span class="dl">"</span><span class="p">,</span><span class="nx">value</span><span class="p">:</span> <span class="dl">"</span><span class="s2">mean_temp</span><span class="dl">"</span><span class="p">)</span>
<span class="o">|&gt;</span> <span class="nx">to</span><span class="p">(</span><span class="nx">bucket</span><span class="p">:</span> <span class="dl">"</span><span class="s2">downsampled</span><span class="dl">"</span><span class="p">,</span> <span class="nx">org</span><span class="p">:</span> <span class="dl">"</span><span class="s2">my-org</span><span class="dl">"</span><span class="p">,</span> <span class="nx">tagColumns</span><span class="p">:</span> <span class="p">[</span><span class="dl">"</span><span class="s2">agg_type</span><span class="dl">"</span><span class="p">])</span>

<span class="nx">data</span>
<span class="o">|&gt;</span> <span class="nx">count</span><span class="p">()</span>
<span class="o">|&gt;</span> <span class="kd">set</span><span class="p">(</span><span class="nx">key</span><span class="p">:</span> <span class="dl">"</span><span class="s2">agg_type</span><span class="dl">"</span><span class="p">,</span><span class="nx">value</span><span class="p">:</span> <span class="dl">"</span><span class="s2">count_temp</span><span class="dl">"</span><span class="p">)</span>
<span class="o">|&gt;</span> <span class="nx">to</span><span class="p">(</span><span class="nx">bucket</span><span class="p">:</span> <span class="dl">"</span><span class="s2">downsampled</span><span class="dl">"</span><span class="p">,</span> <span class="nx">org</span><span class="p">:</span> <span class="dl">"</span><span class="s2">my-org</span><span class="dl">"</span><span class="p">,</span> <span class="nx">tagColumns</span><span class="p">:</span> <span class="p">[</span><span class="dl">"</span><span class="s2">agg_type</span><span class="dl">"</span><span class="p">])</span>
</code></pre></div></div><h2 id="dividing-processing-work-across-multiple-tasks"> <a href="#dividing-processing-work-across-multiple-tasks" class="anchor-heading" aria-labelledby="dividing-processing-work-across-multiple-tasks"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Dividing processing work across multiple tasks</h2><p>Are you trying to perform schema mutations, pivots, joins, complex math, and mappings all in the same task? If you are and you’re experiencing a long execution time, consider splitting up some of this work across multiple tasks instead. Separating the processing work out and executing these tasks in parallel can help you reduce your overall execution time.</p><h2 id="the-flux-profiler-package"> <a href="#the-flux-profiler-package" class="anchor-heading" aria-labelledby="the-flux-profiler-package"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> The Flux Profiler package</h2><p>The <a href="https://docs.influxdata.com/influxdb/cloud/reference/flux/stdlib/profiler/">Flux Profiler package</a> provides performance information based on your query. As per the documentation, the following Flux query:</p><div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="dl">"</span><span class="s2">profiler</span><span class="dl">"</span>

<span class="nx">option</span> <span class="nx">profiler</span><span class="p">.</span><span class="nx">enabledProfilers</span> <span class="o">=</span> <span class="p">[</span><span class="dl">"</span><span class="s2">query</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">operator</span><span class="dl">"</span><span class="p">]</span>

<span class="k">from</span><span class="p">(</span><span class="nx">bucket</span><span class="p">:</span> <span class="dl">"</span><span class="s2">noaa</span><span class="dl">"</span><span class="p">)</span>
  <span class="o">|&gt;</span> <span class="nx">range</span><span class="p">(</span><span class="nx">start</span><span class="p">:</span> <span class="mi">2019</span><span class="o">-</span><span class="mi">08</span><span class="o">-</span><span class="mi">17</span><span class="nx">T00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="nx">Z</span><span class="p">,</span> <span class="nx">stop</span><span class="p">:</span> <span class="mi">2019</span><span class="o">-</span><span class="mi">08</span><span class="o">-</span><span class="mi">17</span><span class="nx">T00</span><span class="p">:</span><span class="mi">30</span><span class="p">:</span><span class="mi">00</span><span class="nx">Z</span><span class="p">)</span>
  <span class="o">|&gt;</span> <span class="nx">filter</span><span class="p">(</span><span class="nx">fn</span><span class="p">:</span> <span class="p">(</span><span class="nx">r</span><span class="p">)</span> <span class="o">=&gt;</span>
    <span class="nx">r</span><span class="p">.</span><span class="nx">_measurement</span> <span class="o">==</span> <span class="dl">"</span><span class="s2">h2o_feet</span><span class="dl">"</span> <span class="nx">and</span>
    <span class="nx">r</span><span class="p">.</span><span class="nx">_field</span> <span class="o">==</span> <span class="dl">"</span><span class="s2">water_level</span><span class="dl">"</span> <span class="nx">and</span>
    <span class="nx">r</span><span class="p">.</span><span class="nx">location</span> <span class="o">==</span> <span class="dl">"</span><span class="s2">coyote_creek</span><span class="dl">"</span>
  <span class="p">)</span>
  <span class="o">|&gt;</span> <span class="nx">map</span><span class="p">(</span><span class="nx">fn</span><span class="p">:</span> <span class="p">(</span><span class="nx">r</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">({</span> <span class="nx">r</span> <span class="kd">with</span>
    <span class="na">_value</span><span class="p">:</span> <span class="nx">r</span><span class="p">.</span><span class="nx">_value</span> <span class="o">*</span> <span class="mf">12.0</span><span class="p">,</span>
    <span class="na">_measurement</span><span class="p">:</span> <span class="dl">"</span><span class="s2">h2o_inches</span><span class="dl">"</span>
  <span class="p">}))</span>
  <span class="o">|&gt;</span> <span class="nx">drop</span><span class="p">(</span><span class="nx">columns</span><span class="p">:</span> <span class="p">[</span><span class="dl">"</span><span class="s2">_start</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">_stop</span><span class="dl">"</span><span class="p">])</span>
</code></pre></div></div><p>Yields the following tables from the Profiler:</p><p><img src="/time-to-awesome/assets/images/image-32.png" alt="" /></p><p>The Flux Profiler outputs performance information about your query in nanoseconds.</p><ul><li>The first table provides information about your entire query including the total duration time it took to execute the query as well as the time it spent compiling, in the queue, etc.<li>The second table provides information about where the query is spending the most amount of time.</ul><p>The two most important columns to pay attention to are the TotalDuration column from the first table and the DurationSum column from the second table. This query is executed very quickly, so I don’t have to worry about optimizing it. However, I’ll describe the thought process for optimizing it further.</p><p>First I would try to identify which part of the query is taking the longest to execute. From the query above, we can see that the merged_ReadRange5_filter operation has the largest DurationSum of 529282 ns. If I was planning to convert this query to a task and perform this transformation work on a schedule, the first thing I should consider is querying data over a shorter range and running the task more frequently.</p><p>Next, I notice that the <a href="https://docs.influxdata.com/influxdb/cloud/reference/flux/stdlib/built-in/transformations/map/">map()</a> function contributes the second longest DurationSum value. Taking a look back at my <a href="https://docs.influxdata.com/influxdb/cloud/reference/flux/stdlib/built-in/transformations/map/">map()</a> function, I have to wonder if renaming the measurement with <a href="https://docs.influxdata.com/influxdb/cloud/reference/flux/stdlib/built-in/transformations/map/">map()</a> is the most efficient way. Perhaps I should try using the <a href="https://docs.influxdata.com/influxdb/cloud/reference/flux/stdlib/built-in/transformations/set/">set()</a> function instead like so:</p><div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">from</span><span class="p">(</span><span class="nx">bucket</span><span class="p">:</span> <span class="dl">"</span><span class="s2">noaa</span><span class="dl">"</span><span class="p">)</span>
  <span class="o">|&gt;</span> <span class="nx">range</span><span class="p">(</span><span class="nx">start</span><span class="p">:</span> <span class="mi">2019</span><span class="o">-</span><span class="mi">08</span><span class="o">-</span><span class="mi">17</span><span class="nx">T00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="nx">Z</span><span class="p">,</span> <span class="nx">stop</span><span class="p">:</span> <span class="mi">2019</span><span class="o">-</span><span class="mi">08</span><span class="o">-</span><span class="mi">17</span><span class="nx">T00</span><span class="p">:</span><span class="mi">30</span><span class="p">:</span><span class="mi">00</span><span class="nx">Z</span><span class="p">)</span>
  <span class="o">|&gt;</span> <span class="nx">filter</span><span class="p">(</span><span class="nx">fn</span><span class="p">:</span> <span class="p">(</span><span class="nx">r</span><span class="p">)</span> <span class="o">=&gt;</span>
    <span class="nx">r</span><span class="p">.</span><span class="nx">_measurement</span> <span class="o">==</span> <span class="dl">"</span><span class="s2">h2o_feet</span><span class="dl">"</span> <span class="nx">and</span>
    <span class="nx">r</span><span class="p">.</span><span class="nx">_field</span> <span class="o">==</span> <span class="dl">"</span><span class="s2">water_level</span><span class="dl">"</span> <span class="nx">and</span>
    <span class="nx">r</span><span class="p">.</span><span class="nx">location</span> <span class="o">==</span> <span class="dl">"</span><span class="s2">coyote_creek</span><span class="dl">"</span>
  <span class="p">)</span>
 <span class="o">|&gt;</span> <span class="nx">drop</span><span class="p">(</span><span class="nx">columns</span><span class="p">:</span> <span class="p">[</span><span class="dl">"</span><span class="s2">_start</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">_stop</span><span class="dl">"</span><span class="p">])</span>
  <span class="o">|&gt;</span> <span class="kd">set</span><span class="p">(</span><span class="nx">key</span><span class="p">:</span> <span class="dl">"</span><span class="s2">_measurement</span><span class="dl">"</span><span class="p">,</span><span class="nx">value</span><span class="p">:</span> <span class="dl">"</span><span class="s2">h2o_inches</span><span class="dl">"</span><span class="p">)</span>
  <span class="o">|&gt;</span> <span class="nx">map</span><span class="p">(</span><span class="nx">fn</span><span class="p">:</span> <span class="p">(</span><span class="nx">r</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">({</span> <span class="nx">r</span> <span class="kd">with</span>
    <span class="na">_value</span><span class="p">:</span> <span class="nx">r</span><span class="p">.</span><span class="nx">_value</span> <span class="o">*</span> <span class="mf">12.0</span><span class="p">,</span>
  <span class="p">}))</span>
</code></pre></div></div><p>Also notice that I switch the order of the functions and apply <a href="https://docs.influxdata.com/influxdb/cloud/reference/flux/stdlib/built-in/transformations/drop/">drop()</a> and <a href="https://docs.influxdata.com/influxdb/cloud/reference/flux/stdlib/built-in/transformations/set/">set()</a> functions before the <a href="https://docs.influxdata.com/influxdb/cloud/reference/flux/stdlib/built-in/transformations/map/">map()</a> function. After running the Profiler, I see a decrease in the TotalDuration time which indicates that these were all good changes. Since performance optimizations are continuously made to Flux and everyone’s schema is very different, there aren’t hard rules for Flux performance optimization. Instead, I encourage you to take advantage of the Profiler and perform some experimentation to find solutions that work best for you.</p><h2 id="using-the-flux-extension-for-visual-studio-code-to-streamline-flux-optimization-discovery"> <a href="#using-the-flux-extension-for-visual-studio-code-to-streamline-flux-optimization-discovery" class="anchor-heading" aria-labelledby="using-the-flux-extension-for-visual-studio-code-to-streamline-flux-optimization-discovery"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Using the Flux extension for Visual Studio Code to streamline Flux optimization discovery</h2><p>If you haven’t given it a try already, I encourage you to install the <a href="https://marketplace.visualstudio.com/items?itemName=influxdata.flux">Flux extension</a> for <a href="https://www.google.com/search?q=visual+studio+code&amp;oq=visual+stu&amp;aqs=chrome.1.0i433l2j69i57j0i433j0j0i433j69i60j69i61.2304j1j7&amp;sourceid=chrome&amp;ie=UTF-8">Visual Studio Code</a>. To query your InfluxDB Cloud account with the Flux extension, you must first configure it and <a href="https://docs.influxdata.com/influxdb/v2.0/tools/flux-vscode/#connect-to-influxdb">connect to your cloud account</a>. I enjoy using the Flux extension and VS Code when trying to debug complicated Flux scripts or trying to optimize the performance of my Flux scripts because I can save my Flux scripts and compare outputs from the Profiler simultaneously.</p><p><img src="/time-to-awesome/assets/images/image-33.png" alt="" /></p><p>The original “bad_join” query (red) is commented out because I ran it first. Its TotalDuration time was 17608617 ns. Joining on multiple like-columns and removing the drop() improves the performance to 14160858 ns.</p><p>I decided to test the queries described in the “Using schema mutations properly” section above. The Profiler confirms my hypothesis: joining on multiple like-columns is more efficient than dropping redundant ones retroactively. While you can also perform this work in the InfluxDB UI, I find the side-by-side comparison of Profiler outputs helpful for this type of experimentation.</p><h2 id="other-tips"> <a href="#other-tips" class="anchor-heading" aria-labelledby="other-tips"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Other tips</h2><p>Here are a list of other substitutions or ideas to consider when trying to optimize the performance of your Flux query:</p><ol><li>Can you use the <a href="https://docs.influxdata.com/influxdb/cloud/reference/flux/stdlib/experimental/join/">experimental.join()</a> function instead of <a href="https://docs.influxdata.com/influxdb/cloud/reference/flux/stdlib/built-in/transformations/join/">join()</a> function?<li>Can you apply any groups that will reduce the number of rows in your table(s) before applying a <a href="https://docs.influxdata.com/influxdb/cloud/reference/flux/stdlib/built-in/transformations/map/">map()</a> function?<li>Can you tune any regexes to be as specific as possible?<li>Can you use rows.map() instead of map()?<li>Does<code class="language-plaintext highlighter-rouge"> |&gt; sort(columns: ["_time"], desc: false) |&gt; limit(n:1)</code> perform better than<code class="language-plaintext highlighter-rouge"> |&gt; last()</code>?</ol><h2 id="best-practices-for-receiving-help"> <a href="#best-practices-for-receiving-help" class="anchor-heading" aria-labelledby="best-practices-for-receiving-help"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Best practices for receiving help</h2><p>When asking for help with optimizing the performance of your Flux script, whether it’s on the <a href="https://community.influxdata.com/">community forums</a>, <a href="https://influxdata.com/slack">Slack</a>, or through <a href="https://support.influxdata.com/s/">support</a>, please include the following information in your post or request:</p><ul><li>What is the query that’s having an issue?<ul><li>Make sure to share it as well as including the output from the Profiler.</ul><li>What is the cardinality of your data? (how many series)<ul><li>Try using the <a href="https://github.com/influxdata/community-templates/tree/master/influxdb2_operational_monitoring">InfluxDB Operational Monitoring Template</a> to help you find the cardinality of your data.<li>Alternatively try using the <a href="https://docs.influxdata.com/influxdb/v2.0/reference/flux/stdlib/influxdb/cardinality/">schema.cardinality()</a> function to help you find the cardinality of your data.</ul><li>What is the density of your data? (how many points per unit time in each series)<ul><li>Try using the <a href="https://github.com/influxdata/community-templates/tree/master/usage_dashboard">InfluxDB Cloud Usage Template</a> to help you identify the data into your InfluxDB Cloud account.</ul><li>General information about how your data is structured (which measurements, fields and tag keys exist) is always helpful.<ul><li>Try using the <a href="https://docs.influxdata.com/influxdb/cloud/reference/flux/stdlib/influxdb-schema/">schema package</a> to share your data structure.</ul><li>What is your expectation of how fast a query should run? What’s the basis for that expectation?</ul><p>Including as much of this information in a post will help us assist you better and more quickly. The above points also apply to issues with hitting memory limits.</p><p><a href="/time-to-awesome/docs/part-2/part-3" class="btn btn-purple">Part 3</a></p><hr><footer><p><a href="#top" id="back-to-top">Back to top</a></p><p class="text-small text-grey-dk-100 mb-0">Copyright &copy; InfluxData.</p><div class="d-flex mt-2"><p class="text-small text-grey-dk-000 mb-0"> <a href="https://github.com/pmarsceill/just-the-docs/tree/master/docs/part-2/optimizing-flux-performance.md" id="edit-this-page">Edit this page on GitHub</a></p></div></footer></div></div><div class="search-overlay"></div></div>
